#!/usr/bin/env bash
# ============================================================================
# ‚öôÔ∏è YADM Bootstrap Script
# ============================================================================
# This script bootstraps the user's environment by installing necessary
# tools and configurations using Homebrew and other utilities.
# It is intended to be run as part of the YADM dotfiles management system.
# ============================================================================

set -euo pipefail

# ============================================================================
# IMPORT COMMON UTILITIES
# ============================================================================

COMMON_SCRIPT="${HOME}/scripts/common.sh"

if [[ ! -f "${COMMON_SCRIPT}" ]]; then
    echo "ERROR: common.sh not found at: ${COMMON_SCRIPT}" >&2
    echo "Please ensure common.sh exists in ~/scripts/ directory." >&2
    exit 1
fi

source "${COMMON_SCRIPT}"

# ============================================================================
# GLOBAL VARIABLES
# ============================================================================

K3SUP_TLS_SAN="127.0.0.1"
K3S_SETUP_STATUS="not_available"

trap cleanup EXIT

# ============================================================================
# OS CHECK
# ============================================================================

check_os() {
    print_info "Operating System: $OS"
    print_info "Architecture: $ARCH"

    if [[ "$OS" != "Darwin" && "$OS" != "Linux" ]]; then
        print_error "Unsupported OS: $OS"
        exit 1
    fi

    if [[ "$OS" = "Linux" ]] && grep -qi 'microsoft' /proc/version 2>/dev/null; then
        IS_WSL=true
        K3SUP_TLS_SAN=$(ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -n1)
        print_info "WSL environment detected"
    fi
}

# ============================================================================
# INSTALL BREW DEPS
# ============================================================================

install_brew_deps() {
    print_step "Selecting Brewfile..."

    local brewfile

    if [ "$OS" = "Darwin" ]; then
        brewfile="$HOME/.config/yadm/Brewfile.macos"
    else
        brewfile="$HOME/.config/yadm/Brewfile.linux"
    fi

    print_info "Using Brewfile: $brewfile"

    if [[ ! -f "$brewfile" ]]; then
        print_error "Brewfile not found!"
        exit 1
    fi

    print_info "Installing Brewfile packages‚Ä¶"
    if brew bundle --file="$brewfile" --no-upgrade; then
        print_success "Brewfile packages installed"
    else
        print_warning "Some Brew packages failed"
    fi
}

# ============================================================================
# ZSH SETUP
# ============================================================================

setup_zsh() {
    print_step "Configuring zsh shell‚Ä¶"

    local current=$(basename "$SHELL" || echo "unknown")
    print_info "Current shell: $current"

    if [[ "$current" != "zsh" ]]; then
        print_warning "zsh is not the default shell. Attempting to change default shell..."

        local zsh_path
        zsh_path=$(command -v zsh)

        print_info "zsh path: $zsh_path"

        if ! grep -q "^${zsh_path}$" /etc/shells 2>/dev/null; then
            print_warning "Adding zsh to /etc/shells"
            echo "$zsh_path" | sudo tee -a /etc/shells >/dev/null
        fi

        print_info "Changing default shell‚Ä¶"
        if [ "$OS" = "Darwin" ]; then
            if chsh -s "$zsh_path"; then
                print_success "Default shell changed to zsh"
                print_warning "Please log out and log back in for the shell change to take effect"
            else
                print_error "Failed to change default shell to zsh via usermod"
                print_error "Please run manually: chsh -s $zsh_path"
                exit 1
            fi
        else
            if sudo usermod -s "$zsh_path" "$USER" 2>/dev/null; then
                print_success "Default shell changed to zsh via usermod"
                print_warning "Please log out and log back in for the shell change to take effect"
            else
                print_error "Failed to change default shell to zsh via usermod"
                exit 1
            fi
        fi
    else
        print_success "zsh is already default"
    fi

    if [[ ! -f "$HOME/.zshrc" ]]; then
        print_error "~/.zshrc not found ‚Äî is your dotfiles setup incomplete?"
        exit 1
    fi

    print_success "zsh config OK"
}

# ============================================================================
# KUBE CONFIG
# ============================================================================

kube_config() {
    [[ "$OS" = "Darwin" ]] && return 0

    print_step "Setting up Kubernetes configuration directory‚Ä¶"

    mkdir -p "$HOME/.kube"

    local file="$HOME/.kube/config"

    if [[ -f "$file" ]]; then
        local backup="$file.backup.$(date +%Y%m%d-%H%M%S)"
        print_info "Backing up existing kubeconfig ‚Üí $backup"
        cp "$file" "$backup"
    else
        print_info "Creating default kubeconfig"
        /bin/cat > "$file" << 'EOF'
apiVersion: v1
kind: Config
clusters: []
contexts: []
current-context: ""
preferences: {}
users: []
EOF
        chmod 600 "$file"
    fi

    print_success "Kube config initialized"
}

# ============================================================================
# INSTALL K3S
# ============================================================================

install_k3s() {
    [[ "$OS" = "Darwin" ]] && return 0
    command -v k3sup >/dev/null || return 0

    print_step "Local Kubernetes cluster setup (optional)"

    if [[ $(prompt_user "Install local k3s cluster?" "Y") =~ ^[Yy]$ ]]; then
        print_info "Installing k3s‚Ä¶"

        if k3sup install \
            --local \
            --local-path "$HOME/.kube/config" \
            --merge \
            --context "local" \
            --k3s-extra-args "--disable traefik --disable metrics-server" \
            --tls-san "$K3SUP_TLS_SAN"; then

            print_success "k3s installed"

            print_info "Checking cluster readiness‚Ä¶"

            if k3sup ready --context="local" --kubeconfig="$HOME/.kube/config"; then
                print_success "Cluster ready!"
                K3S_SETUP_STATUS="installed"
            else
                print_warning "Cluster readiness timed out"
                K3S_SETUP_STATUS="installed_pending"
            fi
        else
            print_error "k3s install failed"
            K3S_SETUP_STATUS="failed"
        fi
    else
        print_info "Skipping k3s installation"
        K3S_SETUP_STATUS="skipped"
    fi
}

# ============================================================================
# SECRET DECRYPTION
# ============================================================================

decrypt_secrets() {
    if [[ $(prompt_user "Decrypt yadm secrets?" "Y") =~ ^[Yy]$ ]]; then
        print_step "Decrypting secrets‚Ä¶"

        if yadm decrypt; then
            print_success "Secrets decrypted"

            local repo=$(yadm remote get-url origin 2>/dev/null || echo "")

            if [[ "$repo" =~ ^https:// ]]; then
                if [[ $(prompt_user "Switch yadm to SSH remote?" "Y") =~ ^[Yy]$ ]]; then
                    local suggested=$(echo "$repo" | sed -E 's|https://([^/]+)/|git@\1:|')
                    print_info "Suggested SSH URL: $suggested"
                    read -rp "$(echo -e "${CYAN}Enter your SSH URL (or press Enter to use suggested): ${RESET}")" ssh
                    ssh="${ssh:-$suggested}"

                    if [[ -n "$ssh" ]]; then
                        if yadm remote set-url origin "$ssh"; then
                            print_success "yadm remote switched to SSH: $ssh"
                        else
                            print_error "Failed to switch remote to SSH"
                        fi
                    else
                        print_warning "No SSH URL provided. Skipping remote switch."
                    fi
                fi
            else
                print_info "Repository already uses SSH or non-HTTPS protocol. No remote switch needed."
            fi
        else
            print_warning "Secrets decryption skipped. You can decrypt later with: yadm decrypt"
        fi
    else
        print_info "Skipping secret decryption"
    fi
}

# ============================================================================
# COMPLETION
# ============================================================================

show_completion_summary() {
    print_header "üéâ Bootstrap Completed Successfully"

    echo -e "${GREEN}All tasks finished without critical errors.${RESET}"
    echo -e ""

    # Kubernetes status summary
    if [ "${K3S_SETUP_STATUS:-}" = "installed" ]; then
        echo -e "${CYAN}‚ò∏Ô∏è  Kubernetes cluster:${RESET}"
        echo -e "  ${GREEN}‚úì${RESET} Local k3s cluster is ready"
        echo -e "  ${BLUE}‚Ä¢${RESET} Use ${YELLOW}kubectl --context=local${RESET} to interact with your cluster"
        echo -e "  ${BLUE}‚Ä¢${RESET} Or switch context: ${YELLOW}kubectx local${RESET}"

    elif [ "${K3S_SETUP_STATUS:-}" = "installed_pending" ]; then
        echo -e "${CYAN}‚ò∏Ô∏è  Kubernetes cluster:${RESET}"
        echo -e "  ${YELLOW}‚è≥${RESET} Cluster installed but readiness check pending"
        echo -e "  ${BLUE}‚Ä¢${RESET} Try manually: ${YELLOW}kubectl --context=local get nodes${RESET}"

    elif [ "${K3S_SETUP_STATUS:-}" = "skipped" ]; then
        echo -e "${CYAN}‚ò∏Ô∏è  Kubernetes cluster setup (optional):${RESET}"
        echo -e "  ${BLUE}‚Ä¢${RESET} To install later: ${YELLOW}k3sup install --local --local-path ~/.kube/config --merge --context local${RESET}"

    elif [ "${K3S_SETUP_STATUS:-}" = "failed" ]; then
        echo -e "${CYAN}‚ò∏Ô∏è  Kubernetes cluster:${RESET}"
        echo -e "  ${RED}‚úó${RESET} Cluster installation failed"
        echo -e "  ${BLUE}‚Ä¢${RESET} Try again: ${YELLOW}k3sup install --local --local-path ~/.kube/config --merge --context local${RESET}"

    elif [ "${K3S_SETUP_STATUS:-}" = "not_available" ]; then
        echo -e "${CYAN}‚ò∏Ô∏è  Kubernetes cluster:${RESET}"
        echo -e "  ${BLUE}‚Ä¢${RESET} Use Orbstack to spin up a local k8s cluster: ${YELLOW}open the app and select Kubernetes${RESET}"
    fi

    echo -e ""
    echo -e "${CYAN}üìù Next steps:${RESET}"
    echo -e "  ${BLUE}*${RESET} Restart your shell in order for all changes to take effect"
    echo -e "  ${BLUE}*${RESET} Type ${YELLOW}help${RESET} to see available commands (if aliases are configured)"

    if [ "${IS_WSL:-false}" = true ] && [ "${K3S_SETUP_STATUS:-}" != "failed" ]; then
        echo -e ""
        echo -e "${CYAN}üñ•Ô∏è  Interacting with the Kubernetes cluster installed inside WSL on Windows Apps (Lens, etc.):${RESET}"
        echo -e "  ${BLUE}‚Ä¢${RESET} Create/edit Windows Kubeconfig: ${YELLOW}mnt/c/Users/%USERNAME%/.kube/config${RESET}"
        echo -e "  ${BLUE}‚Ä¢${RESET} The cluster is accessible from Windows via WSL IP"
        echo -e "  ${BLUE}‚Ä¢${RESET} Update the cluster's server IP to $K3SUP_TLS_SAN${RESET}"
    fi
}

# ============================================================================
# MAIN
# ============================================================================

main() {
    print_header "üöÄ YADM Bootstrap Starting"

    check_os
    install_brew_deps
    setup_zsh
    kube_config
    install_k3s
    decrypt_secrets

    show_completion_summary
}

main "$@"
